<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logs del Sistema - Firebase Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: #1a202c;
            color: #e2e8f0;
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #2d3748;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .header h1 {
            color: #fff;
            font-size: 1.5rem;
            font-weight: 600;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
        }

        .btn-secondary {
            background: #4a5568;
            color: #e2e8f0;
        }

        .btn-secondary:hover {
            background: #718096;
        }

        .btn-danger {
            background: #e53e3e;
            color: white;
        }

        .btn-danger:hover {
            background: #c53030;
        }

        .controls-bar {
            background: #2d3748;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            flex-shrink: 0;
        }

        .filters {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.8rem;
            color: #a0aec0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .filter-select, .filter-input {
            padding: 0.5rem;
            border: 1px solid #4a5568;
            border-radius: 4px;
            background: #1a202c;
            color: #e2e8f0;
            font-size: 0.8rem;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        .filter-select:focus, .filter-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .status-info {
            display: flex;
            gap: 2rem;
            align-items: center;
            font-size: 0.8rem;
            color: #a0aec0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #38a169;
        }

        .status-dot.disconnected {
            background: #e53e3e;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .logs-container {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .logs-viewer {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            font-size: 0.85rem;
            line-height: 1.4;
            background: #1a202c;
        }

        .log-entry {
            margin-bottom: 1px;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            white-space: pre-wrap;
            word-break: break-word;
            transition: background-color 0.3s;
        }

        .log-entry:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .log-entry.highlighted {
            background: rgba(255, 255, 0, 0.1);
            border-left: 3px solid #ffd700;
            padding-left: 0.75rem;
        }

        .log-timestamp {
            color: #a0aec0;
            font-weight: normal;
        }

        .log-level {
            font-weight: bold;
            margin: 0 0.5rem;
            padding: 0.1rem 0.4rem;
            border-radius: 3px;
            font-size: 0.7rem;
        }

        .log-level.ERROR {
            background: #742a2a;
            color: #fed7d7;
        }

        .log-level.WARN {
            background: #744210;
            color: #fefcbf;
        }

        .log-level.INFO {
            background: #2a4365;
            color: #bee3f8;
        }

        .log-level.DEBUG {
            background: #22543d;
            color: #c6f6d5;
        }

        .log-module {
            color: #9f7aea;
            font-weight: 500;
        }

        .log-message {
            color: #e2e8f0;
        }

        .log-search-highlight {
            background: #ffd700;
            color: #1a202c;
            padding: 0.1rem 0.2rem;
            border-radius: 2px;
        }

        .footer-bar {
            background: #2d3748;
            padding: 0.75rem 1.5rem;
            border-top: 1px solid #4a5568;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: #a0aec0;
            flex-shrink: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .log-stats {
            display: flex;
            gap: 2rem;
        }

        .log-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .auto-scroll-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            user-select: none;
        }

        .toggle-switch {
            width: 40px;
            height: 20px;
            background: #4a5568;
            border-radius: 10px;
            position: relative;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #667eea;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }

        .toggle-switch.active::after {
            left: 22px;
        }

        .search-container {
            position: relative;
            margin-right: 1rem;
        }

        .search-input {
            padding: 0.5rem 2rem 0.5rem 0.75rem;
            border: 1px solid #4a5568;
            border-radius: 4px;
            background: #1a202c;
            color: #e2e8f0;
            font-size: 0.8rem;
            width: 200px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            width: 300px;
        }

        .search-clear {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #a0aec0;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .search-clear:hover {
            color: #e2e8f0;
        }

        .level-filter {
            display: flex;
            gap: 0.25rem;
        }

        .level-toggle {
            padding: 0.25rem 0.5rem;
            border: 1px solid #4a5568;
            background: #2d3748;
            color: #a0aec0;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.3s;
        }

        .level-toggle.active {
            border-color: #667eea;
            background: #667eea;
            color: white;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #a0aec0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .loading-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #a0aec0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #4a5568;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }
            
            .controls-bar {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .filters {
                justify-content: center;
            }
            
            .status-info {
                justify-content: center;
            }
            
            .search-input {
                width: 100%;
            }
            
            .search-input:focus {
                width: 100%;
            }
        }

        /* Custom scrollbar */
        .logs-viewer::-webkit-scrollbar {
            width: 8px;
        }

        .logs-viewer::-webkit-scrollbar-track {
            background: #2d3748;
        }

        .logs-viewer::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 4px;
        }

        .logs-viewer::-webkit-scrollbar-thumb:hover {
            background: #718096;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                <i class="fas fa-file-alt"></i>
                Logs del Sistema
            </h1>
            <div class="header-controls">
                <a href="/admin" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    Dashboard
                </a>
                <button class="btn btn-primary" onclick="downloadLogs()">
                    <i class="fas fa-download"></i>
                    Descargar
                </button>
                <button class="btn btn-danger" onclick="clearLogs()">
                    <i class="fas fa-trash"></i>
                    Limpiar
                </button>
            </div>
        </div>

        <!-- Controls Bar -->
        <div class="controls-bar">
            <div class="filters">
                <div class="filter-group">
                    <span class="filter-label">Nivel:</span>
                    <div class="level-filter">
                        <div class="level-toggle active" data-level="ERROR" onclick="toggleLevel('ERROR')">ERROR</div>
                        <div class="level-toggle active" data-level="WARN" onclick="toggleLevel('WARN')">WARN</div>
                        <div class="level-toggle active" data-level="INFO" onclick="toggleLevel('INFO')">INFO</div>
                        <div class="level-toggle active" data-level="DEBUG" onclick="toggleLevel('DEBUG')">DEBUG</div>
                    </div>
                </div>
                
                <div class="filter-group">
                    <span class="filter-label">M√≥dulo:</span>
                    <select class="filter-select" id="moduleFilter">
                        <option value="">Todos los m√≥dulos</option>
                        <option value="firebase">Firebase</option>
                        <option value="queue">Queue</option>
                        <option value="api">API</option>
                        <option value="websocket">WebSocket</option>
                        <option value="database">Database</option>
                        <option value="system">System</option>
                    </select>
                </div>

                <div class="filter-group">
                    <span class="filter-label">Per√≠odo:</span>
                    <select class="filter-select" id="periodFilter">
                        <option value="live">Tiempo Real</option>
                        <option value="1h">√öltima Hora</option>
                        <option value="24h">√öltimas 24h</option>
                        <option value="7d">√öltimos 7 d√≠as</option>
                    </select>
                </div>

                <div class="search-container">
                    <input type="text" class="search-input" id="searchInput" placeholder="Buscar en logs...">
                    <button class="search-clear" onclick="clearSearch()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <div class="status-info">
                <div class="status-item">
                    <div class="status-dot connected" id="connectionStatus"></div>
                    <span id="connectionText">Conectado</span>
                </div>
                <div class="status-item">
                    <i class="fas fa-server"></i>
                    <span>Sistema: <span id="systemStatus">Online</span></span>
                </div>
            </div>
        </div>

        <!-- Logs Container -->
        <div class="logs-container">
            <div class="logs-viewer" id="logsViewer">
                <div class="loading-state">
                    <div class="loading"></div>
                    <span>Conectando al servidor de logs...</span>
                </div>
            </div>
        </div>

        <!-- Footer Bar -->
        <div class="footer-bar">
            <div class="log-stats">
                <span>Total: <span id="totalLogs">0</span></span>
                <span>Errores: <span id="errorCount">0</span></span>
                <span>Warnings: <span id="warningCount">0</span></span>
                <span>Filtrados: <span id="filteredCount">0</span></span>
            </div>
            
            <div class="log-controls">
                <div class="auto-scroll-toggle" onclick="toggleAutoScroll()">
                    <span>Auto-scroll</span>
                    <div class="toggle-switch active" id="autoScrollToggle"></div>
                </div>
                
                <span>L√≠neas: <span id="maxLines">1000</span></span>
                
                <button class="btn btn-secondary" onclick="pauseResumeLogs()">
                    <i class="fas fa-pause" id="pauseIcon"></i>
                    <span id="pauseText">Pausar</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // LOGS VIEWER
        // ==========================================

        class LogsViewer {
            constructor() {
                this.socket = null;
                this.logs = [];
                this.filteredLogs = [];
                this.activeLevels = new Set(['ERROR', 'WARN', 'INFO', 'DEBUG']);
                this.searchTerm = '';
                this.moduleFilter = '';
                this.periodFilter = 'live';
                this.autoScroll = true;
                this.isPaused = false;
                this.maxLines = 1000;
                this.stats = {
                    total: 0,
                    error: 0,
                    warn: 0,
                    info: 0,
                    debug: 0
                };
                
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.initializeWebSocket();
                this.loadHistoricalLogs();
            }

            setupEventListeners() {
                // Search input
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.searchTerm = e.target.value.toLowerCase();
                    this.filterLogs();
                });

                // Module filter
                document.getElementById('moduleFilter').addEventListener('change', (e) => {
                    this.moduleFilter = e.target.value;
                    this.filterLogs();
                });

                // Period filter
                document.getElementById('periodFilter').addEventListener('change', (e) => {
                    this.periodFilter = e.target.value;
                    if (e.target.value === 'live') {
                        this.connectWebSocket();
                    } else {
                        this.loadHistoricalLogs();
                    }
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch (e.key) {
                            case 'f':
                                e.preventDefault();
                                document.getElementById('searchInput').focus();
                                break;
                            case 'k':
                                e.preventDefault();
                                this.clearLogs();
                                break;
                        }
                    }
                });

                // Auto-scroll on wheel
                const logsViewer = document.getElementById('logsViewer');
                logsViewer.addEventListener('wheel', () => {
                    const isAtBottom = logsViewer.scrollTop + logsViewer.clientHeight >= logsViewer.scrollHeight - 10;
                    if (!isAtBottom && this.autoScroll) {
                        this.setAutoScroll(false);
                    }
                });
            }

            initializeWebSocket() {
                if (this.periodFilter === 'live') {
                    this.connectWebSocket();
                }
            }

            connectWebSocket() {
                try {
                    this.socket = io();
                    
                    this.socket.on('connect', () => {
                        console.log('üì° Connected to WebSocket');
                        this.updateConnectionStatus(true);
                        this.socket.emit('subscribe_logs');
                        this.showMessage('Conectado al servidor de logs en tiempo real');
                    });

                    this.socket.on('disconnect', () => {
                        console.log('‚ùå Disconnected from WebSocket');
                        this.updateConnectionStatus(false);
                        this.showMessage('Desconectado del servidor de logs');
                    });

                    this.socket.on('log_entry', (logData) => {
                        if (!this.isPaused) {
                            this.addLogEntry(logData);
                        }
                    });

                    this.socket.on('log_stream', (logsData) => {
                        if (!this.isPaused && Array.isArray(logsData)) {
                            logsData.forEach(log => this.addLogEntry(log));
                        }
                    });

                    this.socket.on('system_status', (status) => {
                        this.updateSystemStatus(status);
                    });

                } catch (error) {
                    console.error('Error connecting to WebSocket:', error);
                    this.updateConnectionStatus(false);
                    this.showMessage('Error conectando al servidor de logs');
                }
            }

            async loadHistoricalLogs() {
                try {
                    this.showMessage('Cargando logs hist√≥ricos...');
                    
                    const params = new URLSearchParams({
                        period: this.periodFilter,
                        level: Array.from(this.activeLevels).join(','),
                        module: this.moduleFilter
                    });

                    const response = await fetch(`/admin/logs?${params}`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const data = await response.json();
                    
                    if (data.success && data.logs) {
                        this.logs = [];
                        this.clearLogsDisplay();
                        
                        data.logs.forEach(log => {
                            this.addLogEntry(log, false);
                        });
                        
                        this.filterLogs();
                        this.showMessage(`Cargados ${data.logs.length} logs del per√≠odo seleccionado`);
                    } else {
                        this.showMessage('No se encontraron logs para el per√≠odo seleccionado');
                    }

                } catch (error) {
                    console.error('Error loading historical logs:', error);
                    this.showMessage('Error cargando logs hist√≥ricos');
                }
            }

            addLogEntry(logData, shouldFilter = true) {
                const logEntry = this.parseLogData(logData);
                
                // Add to logs array
                this.logs.push(logEntry);
                
                // Limit logs array size
                if (this.logs.length > this.maxLines) {
                    this.logs.shift();
                }
                
                // Update stats
                this.updateStats(logEntry);
                
                // Filter and display if needed
                if (shouldFilter) {
                    this.filterLogs();
                } else {
                    this.displayLogEntry(logEntry);
                }
            }

            parseLogData(logData) {
                if (typeof logData === 'string') {
                    // Parse log string format: [timestamp] [level] [module] message
                    const logMatch = logData.match(/\[([^\]]+)\]\s*\[([^\]]+)\]\s*(?:\[([^\]]+)\])?\s*(.*)/);
                    
                    if (logMatch) {
                        return {
                            timestamp: logMatch[1],
                            level: logMatch[2].toUpperCase(),
                            module: logMatch[3] || 'system',
                            message: logMatch[4],
                            raw: logData
                        };
                    } else {
                        return {
                            timestamp: new Date().toISOString(),
                            level: 'INFO',
                            module: 'system',
                            message: logData,
                            raw: logData
                        };
                    }
                } else {
                    // Structured log object
                    return {
                        timestamp: logData.timestamp || new Date().toISOString(),
                        level: (logData.level || 'INFO').toUpperCase(),
                        module: logData.module || 'system',
                        message: logData.message || '',
                        metadata: logData.metadata || {},
                        raw: JSON.stringify(logData)
                    };
                }
            }

            filterLogs() {
                this.filteredLogs = this.logs.filter(log => {
                    // Level filter
                    if (!this.activeLevels.has(log.level)) {
                        return false;
                    }
                    
                    // Module filter
                    if (this.moduleFilter && log.module !== this.moduleFilter) {
                        return false;
                    }
                    
                    // Search filter
                    if (this.searchTerm) {
                        const searchableText = `${log.message} ${log.module} ${log.level}`.toLowerCase();
                        if (!searchableText.includes(this.searchTerm)) {
                            return false;
                        }
                    }
                    
                    return true;
                });
                
                this.displayFilteredLogs();
                this.updateFilteredCount();
            }

            displayFilteredLogs() {
                const logsViewer = document.getElementById('logsViewer');
                logsViewer.innerHTML = '';
                
                if (this.filteredLogs.length === 0) {
                    this.showEmptyState();
                    return;
                }
                
                this.filteredLogs.forEach(log => {
                    this.displayLogEntry(log);
                });
                
                if (this.autoScroll) {
                    this.scrollToBottom();
                }
            }

            displayLogEntry(logEntry) {
                const logsViewer = document.getElementById('logsViewer');
                const logElement = document.createElement('div');
                logElement.className = 'log-entry';
                
                // Format timestamp
                const timestamp = new Date(logEntry.timestamp).toLocaleTimeString('es-ES', {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    timeZoneName: 'short'
                });
                
                // Highlight search terms
                let message = logEntry.message;
                if (this.searchTerm) {
                    const regex = new RegExp(`(${this.escapeRegex(this.searchTerm)})`, 'gi');
                    message = message.replace(regex, '<span class="log-search-highlight">$1</span>');
                    logElement.classList.add('highlighted');
                }
                
                logElement.innerHTML = `
                    <span class="log-timestamp">${timestamp}</span>
                    <span class="log-level ${logEntry.level}">${logEntry.level}</span>
                    <span class="log-module">[${logEntry.module}]</span>
                    <span class="log-message">${message}</span>
                `;
                
                logsViewer.appendChild(logElement);
                
                // Remove old entries if over limit
                while (logsViewer.children.length > this.maxLines) {
                    logsViewer.removeChild(logsViewer.firstChild);
                }
                
                if (this.autoScroll) {
                    this.scrollToBottom();
                }
            }

            updateStats(logEntry) {
                this.stats.total++;
                
                switch (logEntry.level) {
                    case 'ERROR':
                        this.stats.error++;
                        break;
                    case 'WARN':
                        this.stats.warn++;
                        break;
                    case 'INFO':
                        this.stats.info++;
                        break;
                    case 'DEBUG':
                        this.stats.debug++;
                        break;
                }
                
                this.updateStatsDisplay();
            }

            updateStatsDisplay() {
                document.getElementById('totalLogs').textContent = this.stats.total;
                document.getElementById('errorCount').textContent = this.stats.error;
                document.getElementById('warningCount').textContent = this.stats.warn;
            }

            updateFilteredCount() {
                document.getElementById('filteredCount').textContent = this.filteredLogs.length;
            }

            updateConnectionStatus(connected) {
                const statusDot = document.getElementById('connectionStatus');
                const statusText = document.getElementById('connectionText');
                
                if (connected) {
                    statusDot.className = 'status-dot connected';
                    statusText.textContent = 'Conectado';
                } else {
                    statusDot.className = 'status-dot disconnected';
                    statusText.textContent = 'Desconectado';
                }
            }

            updateSystemStatus(status) {
                const systemStatus = document.getElementById('systemStatus');
                systemStatus.textContent = status.healthy ? 'Online' : 'Degraded';
                systemStatus.style.color = status.healthy ? '#38a169' : '#e53e3e';
            }

            toggleLevel(level) {
                const toggle = document.querySelector(`[data-level="${level}"]`);
                
                if (this.activeLevels.has(level)) {
                    this.activeLevels.delete(level);
                    toggle.classList.remove('active');
                } else {
                    this.activeLevels.add(level);
                    toggle.classList.add('active');
                }
                
                this.filterLogs();
            }

            toggleAutoScroll() {
                this.setAutoScroll(!this.autoScroll);
            }

            setAutoScroll(enabled) {
                this.autoScroll = enabled;
                const toggle = document.getElementById('autoScrollToggle');
                
                if (enabled) {
                    toggle.classList.add('active');
                    this.scrollToBottom();
                } else {
                    toggle.classList.remove('active');
                }
            }

            pauseResumeLogs() {
                this.isPaused = !this.isPaused;
                const icon = document.getElementById('pauseIcon');
                const text = document.getElementById('pauseText');
                
                if (this.isPaused) {
                    icon.className = 'fas fa-play';
                    text.textContent = 'Reanudar';
                    this.showMessage('Logs pausados');
                } else {
                    icon.className = 'fas fa-pause';
                    text.textContent = 'Pausar';
                    this.showMessage('Logs reanudados');
                }
            }

            clearLogs() {
                if (confirm('¬øEst√° seguro de que desea limpiar todos los logs?')) {
                    this.logs = [];
                    this.filteredLogs = [];
                    this.stats = {
                        total: 0,
                        error: 0,
                        warn: 0,
                        info: 0,
                        debug: 0
                    };
                    
                    this.clearLogsDisplay();
                    this.updateStatsDisplay();
                    this.updateFilteredCount();
                    this.showMessage('Logs limpiados');
                }
            }

            clearLogsDisplay() {
                document.getElementById('logsViewer').innerHTML = '';
            }

            clearSearch() {
                document.getElementById('searchInput').value = '';
                this.searchTerm = '';
                this.filterLogs();
            }

            downloadLogs() {
                const logs = this.filteredLogs.length > 0 ? this.filteredLogs : this.logs;
                
                if (logs.length === 0) {
                    this.showMessage('No hay logs para descargar');
                    return;
                }
                
                const logText = logs.map(log => {
                    return `[${log.timestamp}] [${log.level}] [${log.module}] ${log.message}`;
                }).join('\n');
                
                const blob = new Blob([logText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `firebase-logs-${new Date().toISOString().split('T')[0]}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.showMessage('Logs descargados');
            }

            scrollToBottom() {
                const logsViewer = document.getElementById('logsViewer');
                logsViewer.scrollTop = logsViewer.scrollHeight;
            }

            showMessage(message) {
                console.log(message);
                // You could show a toast notification here
            }

            showEmptyState() {
                const logsViewer = document.getElementById('logsViewer');
                logsViewer.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <div>No se encontraron logs con los filtros actuales</div>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem;">
                            Prueba ajustando los filtros o el per√≠odo de b√∫squeda
                        </div>
                    </div>
                `;
            }

            escapeRegex(string) {
                return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }
        }

        // Global functions
        function toggleLevel(level) {
            logsViewer.toggleLevel(level);
        }

        function toggleAutoScroll() {
            logsViewer.toggleAutoScroll();
        }

        function pauseResumeLogs() {
            logsViewer.pauseResumeLogs();
        }

        function clearLogs() {
            logsViewer.clearLogs();
        }

        function clearSearch() {
            logsViewer.clearSearch();
        }

        function downloadLogs() {
            logsViewer.downloadLogs();
        }

        // Initialize
        let logsViewer;
        document.addEventListener('DOMContentLoaded', () => {
            logsViewer = new LogsViewer();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (logsViewer && logsViewer.socket) {
                logsViewer.socket.disconnect();
            }
        });
    </script>
</body>
</html>